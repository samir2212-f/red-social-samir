<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin</title>
  <style>
    body {
      background:#0d1117;
      color:#eee;
      font-family: Arial, sans-serif;
      margin:0;
      padding:20px;
    }
    h2 {
      color:#58a6ff;
    }
    .admin-section {
      background:#161b22;
      padding:15px;
      margin-bottom:20px;
      border-radius:10px;
      box-shadow:0 2px 5px rgba(0,0,0,0.4);
    }
    .admin-section h4 {
      margin-top:0;
      color:#ffb347;
    }
    .admin-row {
      padding:8px;
      border-bottom:1px solid #30363d;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .admin-row:last-child {
      border-bottom:none;
    }
    button.admin-input {
      background:#238636;
      border:none;
      color:white;
      padding:5px 10px;
      border-radius:6px;
      cursor:pointer;
    }
    button.admin-input:hover {
      background:#2ea043;
    }
    .admin-grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:20px;
    }
  </style>
</head>
<body>
  <h2>âš¡ Panel de Administrador</h2>
  <div id="adminContent">Cargando...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, doc, deleteDoc, query, orderBy, limit, getDoc 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbKtevrs-_LJuuNEh4IKX3o_vvpFddO5k",
      authDomain: "miredsocial-b50ce.firebaseapp.com",
      projectId: "miredsocial-b50ce",
      storageBucket: "miredsocial-b50ce.appspot.com",
      messagingSenderId: "1087784350299",
      appId: "1:1087784350299:web:4c6b960635700994ef457e",
      measurementId: "G-97HJGYQX6B"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const ADMIN_UIDS = [
      "ZIcK7apXDpY8fFzCYzLaTLQmWrP2",
      "xsAGAbKpfJWuprMKISAKDXyBZQ32"
    ];

    const adminContent = document.getElementById("adminContent");

    onAuthStateChanged(auth, async user=>{
      if(!user){
        adminContent.innerHTML = "<p>Debes iniciar sesiÃ³n.</p>";
        return;
      }
      if(!ADMIN_UIDS.includes(user.uid)){
        adminContent.innerHTML = "<p>No tienes permisos de administrador.</p>";
        return;
      }
      loadAdminData();
    });

    async function loadAdminData(){
      adminContent.innerHTML = `
        <div class="admin-grid">
          <!-- Usuarios -->
          <div class="admin-section">
            <h4>ğŸ‘¥ Usuarios</h4>
            <div id="adminUsers">Cargando...</div>
          </div>

          <!-- Posts -->
          <div class="admin-section">
            <h4>ğŸ“ Ãšltimos posts</h4>
            <div id="adminPosts">Cargando...</div>
          </div>
        </div>

        <!-- Mensajes privados -->
        <div class="admin-section">
          <h4>ğŸ’Œ Mensajes privados</h4>
          <div id="adminPrivates">Cargando...</div>
        </div>

        <!-- Stats -->
        <div class="admin-section">
          <h4>ğŸ“Š Sistema</h4>
          <div id="adminStats">Cargando...</div>
        </div>
      `;

      const adminUsers = document.getElementById("adminUsers");
      const adminPosts = document.getElementById("adminPosts");
      const adminPrivates = document.getElementById("adminPrivates");
      const adminStats = document.getElementById("adminStats");

      // Usuarios
      try{
        const usersSnap = await getDocs(collection(db,"users"));
        adminUsers.innerHTML = "";
        usersSnap.forEach(docu=>{
          const data = docu.data();
          const row = document.createElement("div");
          row.className = "admin-row";
          row.innerHTML = `
            <div><b>${data.nombre||"Sin nombre"}</b><br>
            <small>${data.email||""}</small></div>
            <button class="admin-input" data-deluser="${docu.id}">ğŸ—‘ï¸ Eliminar</button>
          `;
          adminUsers.appendChild(row);
        });
        adminUsers.querySelectorAll("[data-deluser]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-deluser");
            if(confirm("Â¿Eliminar usuario?")){
              await deleteDoc(doc(db,"users",id));
              btn.textContent="âœ… Eliminado";
              btn.disabled=true;
            }
          });
        });
      }catch(e){ adminUsers.innerHTML="Error: "+e; }

      // Posts
      try{
        const postsSnap = await getDocs(query(collection(db,"posts"),orderBy("timestamp","desc"),limit(20)));
        adminPosts.innerHTML="";
        postsSnap.forEach(docu=>{
          const data = docu.data();
          const row = document.createElement("div");
          row.className = "admin-row";
          row.innerHTML = `
            <div><b>${data.author||"Anon"}</b><br>
            ${data.content.slice(0,80)}</div>
            <button class="admin-input" data-delpost="${docu.id}">ğŸ—‘ï¸ Eliminar</button>
          `;
          adminPosts.appendChild(row);
        });
        adminPosts.querySelectorAll("[data-delpost]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-delpost");
            if(confirm("Â¿Eliminar post?")){
              await deleteDoc(doc(db,"posts",id));
              btn.textContent="âœ… Eliminado";
              btn.disabled=true;
            }
          });
        });
      }catch(e){ adminPosts.innerHTML="Error: "+e; }

      // Mensajes privados
      try{
        adminPrivates.innerHTML = "Cargandoâ€¦";
        const privSnap = await getDocs(query(
          collection(db,"privateChat"),
          orderBy("timestamp","desc"),
          limit(100)
        ));
        adminPrivates.innerHTML = "";
        if (privSnap.empty){
          adminPrivates.innerHTML = `<div class="admin-row">No hay mensajes privados.</div>`;
        } else {
          for(const pDoc of privSnap.docs){
            const data = pDoc.data();
            const id = pDoc.id;
            const content = (data.content||"").toString().slice(0,120);
            const time = data.timestamp ? data.timestamp.toDate().toLocaleString() : "";
            let sender = "Usuario";
            if(data.uid){
              const u = await getDoc(doc(db,"users",data.uid));
              if(u.exists()) sender = u.data().nombre || "Usuario";
            }

            const row = document.createElement("div");
            row.className = "admin-row";
            row.innerHTML = `
              <div style="flex:1;">
                <div style="font-weight:bold;">${sender}</div>
                <div style="font-size:12px; color:#aaa;">ID: ${id}</div>
                <div>${content}</div>
                <div style="font-size:12px; color:#888;">${time}</div>
              </div>
              <button class="admin-input" data-delpm="${id}">ğŸ—‘ï¸ Eliminar</button>
            `;
            adminPrivates.appendChild(row);
          }

          adminPrivates.querySelectorAll("[data-delpm]").forEach(btn=>{
            btn.addEventListener("click", async ()=>{
              const id = btn.getAttribute("data-delpm");
              if(confirm("Â¿Eliminar este mensaje privado?")){
                await deleteDoc(doc(db,"privateChat",id));
                btn.textContent = "âœ… Eliminado";
                btn.disabled = true;
              }
            });
          });
        }
      } catch(e){
        adminPrivates.innerHTML = `<div class="admin-row">Error cargando privados: ${e}</div>`;
      }

      // Stats
      try{
        const usersSnap = await getDocs(collection(db,"users"));
        const postsSnap = await getDocs(collection(db,"posts"));
        const privSnap = await getDocs(collection(db,"privateChat"));
        adminStats.innerHTML = `
          <p>ğŸ‘¥ Usuarios: ${usersSnap.size}</p>
          <p>ğŸ“ Posts: ${postsSnap.size}</p>
          <p>ğŸ’Œ Mensajes privados: ${privSnap.size}</p>
        `;
      }catch(e){ adminStats.innerHTML="Error: "+e; }
    }
  </script>
</body>
</html>
