<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Red Social de Samir 🚀</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 0; display: flex; min-height: 100vh; }
    header { background: linear-gradient(90deg, #222, #444); padding: 15px 20px; font-size: 20px; font-weight: bold; color: #fff; display: flex; justify-content: space-between; align-items: center; }
    nav { background: #222; display: flex; justify-content: center; gap: 20px; padding: 10px; }
    nav a { color: #ccc; text-decoration: none; font-weight: bold; position: relative; padding: 6px 12px; border-radius: 6px; }
    nav a:hover { background: #333; color: #fff; }
    #chatNotif { display: none; background: red; color: white; font-size: 12px; padding: 2px 6px; border-radius: 50%; position: absolute; top: -6px; right: -8px; }
    main { flex: 1; padding: 20px; }
    aside { width: 240px; background: #1c1c1c; padding: 15px; border-left: 2px solid #333; }
    .post-box { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    textarea, input[type="file"] { width: 100%; padding: 10px; border-radius: 8px; border: none; outline: none; resize: none; background: #333; color: #eee; margin-bottom: 10px; }
    button { margin-top: 10px; padding: 10px 15px; border: none; border-radius: 6px; background: #0af; color: #fff; cursor: pointer; }
    button:hover { background: #09c; }
    .post { background: #1a1a1a; margin-bottom: 15px; padding: 15px; border-radius: 8px; box-shadow: 0px 0px 5px rgba(255,255,255,0.1); }
    .post strong { color: #0af; }
    .post small { display: block; color: #888; margin-top: 5px; }
    .post img { max-width: 100%; border-radius: 6px; margin-top: 10px; }
    .reactions button { margin-right: 5px; font-size: 14px; background: #333; }
    #profile { position: relative; cursor: pointer; background: #222; padding: 8px 12px; border-radius: 6px; z-index: 20; }
    #profileMenu { display: none; position: absolute; right: 0; top: 40px; background: #222; border: 1px solid #333; border-radius: 6px; padding: 10px; min-width: 180px; z-index: 30; }
    #profileMenu a, #profileMenu button { display: block; padding: 6px; color: #ccc; text-decoration: none; background:none; border:none; width:100%; text-align:left; cursor:pointer; }
    #profileMenu a:hover, #profileMenu button:hover { background: #333; color: #fff; }
    .light { background: #f4f4f4; color: #111; }
    .light nav, .light header, .light aside { background: #ddd; color: #111; }
    .light .post { background: #fff; color: #000; }

    /* ===== Modal / Panel Admin ===== */
    #adminPanelBackdrop {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55);
      z-index: 1000; align-items: center; justify-content: center; padding: 20px;
    }
    #adminPanel {
      background: #1a1a1a; border: 1px solid #333; border-radius: 10px; width: 100%;
      max-width: 980px; max-height: 90vh; overflow: auto; padding: 16px;
      box-shadow: 0 0 20px rgba(0,0,0,0.6);
    }
    #adminPanel h3 { margin: 0 0 10px 0; }
    .admin-bar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .admin-section { background: #222; border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .admin-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px dashed #333; }
    .admin-row:last-child { border-bottom: none; }
    .admin-input { background: #2a2a2a; border: 1px solid #444; color: #eee; border-radius: 6px; padding: 6px 8px; }
    .admin-pill { font-size: 12px; padding: 2px 6px; border-radius: 999px; border: 1px solid #444; }
    .pill-ok { color: #8f8; border-color: #3a3; }
    .pill-bad { color: #f88; border-color: #a33; }
    .admin-close { margin-left: auto; background: #444; }
    .admin-link-hidden { display:none; }
    @media (max-width: 800px){
      .admin-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div style="flex:1; display:flex; flex-direction:column;">
    <header>
      <div>💬 Hablen pe chubeibis</div>
      <div id="profile">👤 <span id="profileName">Cargando...</span>
        <div id="profileMenu">
          <button id="editNameBtn">✏️ Cambiar nombre</button>
          <a href="#" id="logoutBtn">🚪 Salir</a>
        </div>
      </div>
    </header>
    <nav>
      <a href="home.html">🏠 Inicio</a>
      <a href="reels.html">🎥 Subir Reels</a>
      <a href="feed.html">📺 Ver Reels</a>
      <a href="chat.html" id="chatLink">💌 Chat <span id="chatNotif">0</span></a>
      <!-- aparece solo si es admin -->
      <a href="#" id="adminLink" class="admin-link-hidden">⚙️ Panel Admin</a>
      <a href="#" id="toggleMode">🌙</a>
    </nav>
    <main>
      <h2 id="welcome">Bienvenido</h2>
      <section class="post-box">
        <textarea id="postContent" rows="3" placeholder="Escribe un mensaje..."></textarea>
        <input type="file" id="fileInput">
        <button onclick="publishPost()">Enviar mensaje</button>
      </section>
      <section>
        <h2>📝 Mensajes</h2>
        <div id="feed"></div>
      </section>
    </main>
  </div>
  <aside>
    <h3>🟢 Usuarios en línea</h3>
    <ul id="userList"></ul>
  </aside>

  <!-- ===== Modal Panel Admin ===== -->
  <div id="adminPanelBackdrop">
    <div id="adminPanel">
      <div class="admin-bar">
        <h3>⚙️ Panel Admin</h3>
        <button id="adminRefresh" class="admin-input">🔄 Actualizar</button>
        <button id="adminClose" class="admin-close">✖️ Cerrar</button>
      </div>

      <div class="admin-grid">
        <!-- Usuarios -->
        <div class="admin-section">
          <h4>👥 Usuarios</h4>
          <div id="adminUsers"></div>
        </div>

        <!-- Posts -->
        <div class="admin-section">
          <h4>📝 Últimos posts</h4>
          <div id="adminPosts"></div>
        </div>
      </div>

      <div class="admin-section">
        <h4>📊 Sistema</h4>
        <div id="adminStats">Cargando…</div>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot,
    doc, getDoc, getDocs, setDoc, updateDoc, arrayUnion, deleteDoc, limit
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbKtevrs-_LJuuNEh4IKX3o_vvpFddO5k",
    authDomain: "miredsocial-b50ce.firebaseapp.com",
    projectId: "miredsocial-b50ce",
    storageBucket: "miredsocial-b50ce.appspot.com",
    messagingSenderId: "1087784350299",
    appId: "1:1087784350299:web:4c6b960635700994ef457e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ====== Admins autorizados
  const ADMIN_UIDS = new Set([
    "ZIcK7apXDpY8fFzCYzLaTLQmWrP2",
    "xsAGAbKpfJWuprMKISAKDXyBZQ32"
  ]);

  let currentUser;

  onAuthStateChanged(auth, async (user) => {
    if(user){
      currentUser = user;

      // nombre para mostrar
      const userRef = doc(db,"users",user.uid);
      const userSnap = await getDoc(userRef);
      let displayName = user.email;
      if(userSnap.exists() && userSnap.data().nombre){
        displayName = userSnap.data().nombre;
      }
      document.getElementById("profileName").innerText = displayName;
      document.getElementById("welcome").innerText = "Bienvenido, " + displayName;

      // presencia
      await setDoc(doc(db,"onlineUsers",user.uid),{
        email:user.email, lastActive:serverTimestamp(), online:true
      });
      window.addEventListener("beforeunload", async ()=>{
        await deleteDoc(doc(db,"onlineUsers",user.uid));
      });

      // mostrar link admin si corresponde
      if (ADMIN_UIDS.has(user.uid)) {
        const adminLink = document.getElementById("adminLink");
        adminLink.classList.remove("admin-link-hidden");
      }

      loadPosts();
      loadUsers();
      monitorPrivateChat();
    } else {
      window.location.href = "index.html";
    }
  });

  async function publishPost(){
    const content = document.getElementById("postContent").value.trim();
    if(content==="") return;
    await addDoc(collection(db,"chat"),{ uid:currentUser.uid, content, timestamp:serverTimestamp() });
    document.getElementById("postContent").value="";
  }
  window.publishPost=publishPost;

  function loadPosts(){
    const qy=query(collection(db,"chat"),orderBy("timestamp","desc"));
    onSnapshot(qy, async(snapshot)=>{
      const feedDiv=document.getElementById("feed");
      feedDiv.innerHTML="";
      for(const docSnap of snapshot.docs){
        const post=docSnap.data();
        let username="Usuario";
        if(post.uid){
          const userDoc=await getDoc(doc(db,"users",post.uid));
          if(userDoc.exists()) username=userDoc.data().nombre||"Usuario";
        }
        const div=document.createElement("div");
        div.classList.add("post");
        div.innerHTML=`
          <p><strong>${username}</strong></p>
          <p>${post.content||""}</p>
          <div class="reactions">
            <button>👍</button>
            <button>😂</button>
            <button>❤️</button>
          </div>
          <small>${post.timestamp?post.timestamp.toDate().toLocaleString():""}</small>`;
        feedDiv.appendChild(div);
      }
    });
  }

  function loadUsers(){
    const qy=query(collection(db,"onlineUsers"));
    onSnapshot(qy,(snapshot)=>{
      const list=document.getElementById("userList");
      list.innerHTML="";
      snapshot.docs.forEach(d=>{
        const data=d.data();
        const li=document.createElement("li");
        li.innerHTML = `<span style="color:${data.online?'lime':'gray'}">●</span> ${data.email}`;
        list.appendChild(li);
      });
    });
  }

  function monitorPrivateChat(){
    const chatNotif=document.getElementById("chatNotif");
    const qy=query(collection(db,"privateChat"),orderBy("timestamp","desc"));
    onSnapshot(qy,(snapshot)=>{
      let unread=0;
      snapshot.docs.forEach(docSnap=>{
        const msg=docSnap.data();
        if(msg.uid!==currentUser.uid && (!msg.readBy || !msg.readBy.includes(currentUser.uid))){
          unread++;
        }
      });
      if(unread>0){
        chatNotif.style.display="inline-block";
        chatNotif.textContent=unread;
      } else chatNotif.style.display="none";
    });
  }

  document.getElementById("chatLink").addEventListener("click", async ()=>{
    const qy=query(collection(db,"privateChat"),orderBy("timestamp","desc"));
    onSnapshot(qy,(snapshot)=>{
      snapshot.docs.forEach(async(docSnap)=>{
        const msg=docSnap.data();
        if(msg.uid!==currentUser.uid && (!msg.readBy || !msg.readBy.includes(currentUser.uid))){
          await updateDoc(doc(db,"privateChat",docSnap.id),{ readBy: arrayUnion(currentUser.uid) });
        }
      });
    });
  });

  // Cambiar nombre (solo dueño de su perfil)
  document.getElementById("editNameBtn").addEventListener("click", async ()=>{
    const newName = prompt("Escribe tu nuevo nombre:");
    if(newName && currentUser){
      await setDoc(doc(db,"users",currentUser.uid), { nombre:newName }, { merge:true });
      document.getElementById("profileName").innerText = newName;
      document.getElementById("welcome").innerText = "Bienvenido, " + newName;
    }
  });

  document.getElementById("logoutBtn").addEventListener("click",async ()=>{
    if(currentUser) await deleteDoc(doc(db,"onlineUsers",currentUser.uid));
    signOut(auth).then(()=>window.location.href="index.html");
  });

  document.getElementById("toggleMode").addEventListener("click",()=>{
    document.body.classList.toggle("light");
  });

  document.getElementById("profile").addEventListener("click",()=>{
    const menu=document.getElementById("profileMenu");
    menu.style.display=menu.style.display==="block"?"none":"block";
  });

  /* ====== Lógica del Panel Admin ====== */

  const adminBackdrop = document.getElementById("adminPanelBackdrop");
  const adminLink = document.getElementById("adminLink");
  const adminClose = document.getElementById("adminClose");
  const adminRefresh = document.getElementById("adminRefresh");
  const adminUsersBox = document.getElementById("adminUsers");
  const adminPostsBox = document.getElementById("adminPosts");
  const adminStatsBox = document.getElementById("adminStats");

  adminLink?.addEventListener("click", async (e)=>{
    e.preventDefault();
    if (!currentUser || !ADMIN_UIDS.has(currentUser.uid)) return;
    adminBackdrop.style.display = "flex";
    await loadAdminData();
  });

  adminClose.addEventListener("click", ()=>{
    adminBackdrop.style.display = "none";
  });

  adminRefresh.addEventListener("click", loadAdminData);

  async function loadAdminData(){
    // Usuarios (colección users)
    try{
      const usersSnap = await getDocs(collection(db,"users"));
      if (usersSnap.empty){
        adminUsersBox.innerHTML = `<div class="admin-row">No hay documentos en "users". Asegúrate de guardar perfil al menos una vez.</div>`;
      } else {
        adminUsersBox.innerHTML = "";
        usersSnap.forEach(uDoc=>{
          const data = uDoc.data();
          const uid = uDoc.id;
          const nombre = data.nombre || "(sin nombre)";
          const email = data.email || data.correo || "";
          const banned = !!data.banned;

          const row = document.createElement("div");
          row.className = "admin-row";
          row.innerHTML = `
            <div style="min-width:120px;"><span class="admin-pill ${banned?'pill-bad':'pill-ok'}">${banned?'BLOQUEADO':'ACTIVO'}</span></div>
            <div style="flex:1;">
              <div style="font-weight:bold;">${nombre}</div>
              <div style="font-size:12px; color:#aaa;">UID: ${uid}${email?(" · " + email):""}</div>
            </div>
            <input class="admin-input" id="name-${uid}" value="${nombre}">
            <button class="admin-input" data-save="${uid}">💾 Guardar</button>
            <button class="admin-input" data-ban="${uid}">${banned?'🔓 Desbloquear':'🔒 Bloquear'}</button>
          `;
          adminUsersBox.appendChild(row);
        });

        // listeners
        adminUsersBox.querySelectorAll("[data-save]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const uid = btn.getAttribute("data-save");
            const input = document.getElementById(`name-${uid}`);
            const newName = input.value.trim();
            if(!newName) return;
            await setDoc(doc(db,"users",uid), { nombre:newName }, { merge:true });
            btn.textContent = "✅ Guardado";
            setTimeout(()=>btn.textContent="💾 Guardar", 1200);
          });
        });
        adminUsersBox.querySelectorAll("[data-ban]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const uid = btn.getAttribute("data-ban");
            const txt = btn.textContent.includes("Desbloquear");
            const newState = !txt; // si dice desbloquear → estaba bloqueado → pasar a activo (false)
            await setDoc(doc(db,"users",uid), { banned:newState }, { merge:true });
            await loadAdminData();
          });
        });
      }
    } catch(e){
      adminUsersBox.innerHTML = `<div class="admin-row">Error leyendo usuarios: ${e}</div>`;
    }

    // Posts (últimos 50)
    try{
      adminPostsBox.innerHTML = "Cargando…";
      const postsSnap = await getDocs(query(collection(db,"chat"), orderBy("timestamp","desc"), limit(50)));
      adminPostsBox.innerHTML = "";
      if (postsSnap.empty){
        adminPostsBox.innerHTML = `<div class="admin-row">No hay posts.</div>`;
      } else {
        postsSnap.forEach(pDoc=>{
          const data = pDoc.data();
          const id = pDoc.id;
          const content = (data.content||"").toString().slice(0,120);
          const time = data.timestamp ? data.timestamp.toDate().toLocaleString() : "";
          const row = document.createElement("div");
          row.className = "admin-row";
          row.innerHTML = `
            <div style="flex:1;">
              <div style="font-size:12px; color:#aaa;">ID: ${id}</div>
              <div>${content}</div>
              <div style="font-size:12px; color:#888;">${time}</div>
            </div>
            <button class="admin-input" data-del="${id}">🗑️ Eliminar</button>
          `;
          adminPostsBox.appendChild(row);
        });
        adminPostsBox.querySelectorAll("[data-del]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-del");
            if(confirm("¿Eliminar este post?")){
              await deleteDoc(doc(db,"chat",id));
              btn.textContent = "✅ Eliminado";
              btn.disabled = true;
            }
          });
        });
      }
    } catch(e){
      adminPostsBox.innerHTML = `<div class="admin-row">Error cargando posts: ${e}</div>`;
    }

    // Stats simples
    try{
      const usersCount = (await getDocs(collection(db,"users"))).size;
      const onlineCount = (await getDocs(collection(db,"onlineUsers"))).size;
      adminStatsBox.innerHTML = `
        <div class="admin-row">Usuarios (users): <b>${usersCount}</b></div>
        <div class="admin-row">En línea (onlineUsers): <b>${onlineCount}</b></div>
        <div class="admin-row" style="font-size:12px;color:#aaa;">Tip: para eliminar cuentas de Auth o forzar reglas, hazlo con Cloud Functions o desde la consola de Firebase.</div>
      `;
    } catch(e){
      adminStatsBox.innerHTML = `<div class="admin-row">No se pudieron calcular stats: ${e}</div>`;
    }
  }
  </script>
</body>
</html>
