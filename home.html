<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Red Social de Samir 🚀</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 0; display: flex; min-height: 100vh; }
    header { background: linear-gradient(90deg, #222, #444); padding: 15px 20px; font-size: 20px; font-weight: bold; color: #fff; display: flex; justify-content: space-between; align-items: center; }
    nav { background: #222; display: flex; justify-content: center; gap: 20px; padding: 10px; }
    nav a { color: #ccc; text-decoration: none; font-weight: bold; position: relative; padding: 6px 12px; border-radius: 6px; }
    nav a:hover { background: #333; color: #fff; }
    #chatNotif { display: none; background: red; color: white; font-size: 12px; padding: 2px 6px; border-radius: 50%; position: absolute; top: -6px; right: -8px; }
    main { flex: 1; padding: 20px; }
    aside { width: 240px; background: #1c1c1c; padding: 15px; border-left: 2px solid #333; }
    .post-box { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    textarea, input[type="file"] { width: 100%; padding: 10px; border-radius: 8px; border: none; outline: none; resize: none; background: #333; color: #eee; margin-bottom: 10px; }
    button { margin-top: 10px; padding: 10px 15px; border: none; border-radius: 6px; background: #0af; color: #fff; cursor: pointer; }
    button:hover { background: #09c; }
    .post { background: #1a1a1a; margin-bottom: 15px; padding: 15px; border-radius: 8px; box-shadow: 0px 0px 5px rgba(255,255,255,0.1); }
    .post strong { color: #0af; }
    .post small { display: block; color: #888; margin-top: 5px; }
    .post img { max-width: 100%; border-radius: 6px; margin-top: 10px; }
    .reactions button { margin-right: 5px; font-size: 14px; background: #333; }
    #profile { position: relative; cursor: pointer; background: #222; padding: 8px 12px; border-radius: 6px; }
    #profileMenu { display: none; position: absolute; right: 0; top: 40px; background: #222; border: 1px solid #333; border-radius: 6px; padding: 10px; min-width: 180px; z-index: 9999; }
    #profileMenu a, #profileMenu button { display: block; padding: 6px; color: #ccc; text-decoration: none; background:none; border:none; width:100%; text-align:left; cursor:pointer; }
    #profileMenu a:hover, #profileMenu button:hover { background:#333; color:#fff; }
    .light { background: #f4f4f4; color: #111; }
    .light nav, .light header, .light aside { background: #ddd; color: #111; }
    .light .post { background: #fff; color: #000; }
  </style>
</head>
<body>
  <div style="flex:1; display:flex; flex-direction:column;">
    <header>
      <div>💬 Hablen pe chubeibis</div>
      <div id="profile">👤 <span id="profileName">Cargando...</span>
        <div id="profileMenu">
          <button id="editNameBtn">✏️ Cambiar nombre</button>
          <button id="btnAdmin" style="display:none;">🛡️ Panel admin</button>
          <a href="#" id="logoutBtn">🚪 Salir</a>
        </div>
      </div>
    </header>
    <nav>
      <a href="home.html">🏠 Inicio</a>
      <a href="reels.html">🎥 Subir Reels</a>
      <a href="feed.html">📺 Ver Reels</a>
      <a href="chat.html" id="chatLink">💌 Chat <span id="chatNotif">0</span></a>
      <a href="#" id="toggleMode">🌙</a>
    </nav>
    <main>
      <h2 id="welcome">Bienvenido</h2>
      <section class="post-box">
        <textarea id="postContent" rows="3" placeholder="Escribe un mensaje..."></textarea>
        <input type="file" id="fileInput">
        <button onclick="publishPost()">Enviar mensaje</button>
      </section>
      <section>
        <h2>📝 Mensajes</h2>
        <div id="feed"></div>
      </section>
    </main>
  </div>
  <aside>
    <h3>🟢 Usuarios en línea</h3>
    <ul id="userList"></ul>
  </aside>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { 
    getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, 
    doc, getDoc, setDoc, updateDoc, arrayUnion, deleteDoc, limit 
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // 🔹 Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAbKtevrs-_LJuuNEh4IKX3o_vvpFddO5k",
    authDomain: "miredsocial-b50ce.firebaseapp.com",
    projectId: "miredsocial-b50ce",
    storageBucket: "miredsocial-b50ce.appspot.com",
    messagingSenderId: "1087784350299",
    appId: "1:1087784350299:web:4c6b960635700994ef457e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 🔹 Configuración Supabase
  const supabaseUrl = "https://klziukovalzzcinifvaw.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtseml1a292YWx6emNpbmlmdmF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0Mzg1MDcsImV4cCI6MjA3MjAxNDUwN30.edpw-UnymgHSAhp54SX6CCKfEjB7SQDdSrhH3wc-Eh4";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  let currentUser;

  onAuthStateChanged(auth, async (user) => {
    if(user){
      currentUser = user;
      document.getElementById("profileName").innerText = user.email;
      document.getElementById("welcome").innerText = "Bienvenido, " + user.email;
      loadPosts();
    } else {
      window.location.href = "index.html";
    }
  });

  // 🔹 Publicar mensaje con texto + imagen en Supabase
  async function publishPost(){
    const content = document.getElementById("postContent").value.trim();
    const fileInput = document.getElementById("fileInput");
    let imageUrl = null;

    if(fileInput.files.length > 0){
      const file = fileInput.files[0];
      const fileName = Date.now() + "_" + file.name;
      const { error } = await supabase.storage.from("posts").upload(fileName, file);
      if(error){ console.error("Error al subir archivo:", error.message); }
      else {
        const { data: publicData } = supabase.storage.from("posts").getPublicUrl(fileName);
        imageUrl = publicData.publicUrl;
      }
    }

    if(content!=="" || imageUrl){
      await addDoc(collection(db,"chat"),{
        uid: currentUser.uid,
        content,
        imageUrl,
        timestamp: serverTimestamp()
      });
    }

    document.getElementById("postContent").value="";
    fileInput.value="";
  }
  window.publishPost=publishPost;

  function loadPosts(){
    const qy = query(collection(db,"chat"),orderBy("timestamp","desc"), limit(50));
    onSnapshot(qy, async(snapshot)=>{
      const feedDiv=document.getElementById("feed");
      feedDiv.innerHTML="";
      for(const docSnap of snapshot.docs){
        const post=docSnap.data();
        let username="Usuario";
        if(post.uid){
          const userDoc=await getDoc(doc(db,"users",post.uid));
          if(userDoc.exists()) username=userDoc.data().nombre||"Usuario";
        }
        const div=document.createElement("div");
        div.classList.add("post");
        div.innerHTML=`
          <p><strong>${username}</strong></p>
          <p>${post.content||""}</p>
          ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Imagen">` : ""}
          <small>${post.timestamp?post.timestamp.toDate().toLocaleString():""}</small>`;
        feedDiv.appendChild(div);
      }
    });
  }
  </script>
</body>
</html>
